<!DOCTYPE html>
<html lang="en">
<head>
    <title>Map, Set, WeakMap, WeakSet</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://npmcdn.com/shower-ribbon/styles/screen-16x10.css">
    <link rel="stylesheet" href="vendors/prism.css">
</head>
<body class="shower list">
    <header class="caption">
        <h1>Map, Set, WeakMap, WeakSet</h1>
        <p>Piotr Kowalski</p>
    </header>

    <section class="slide">
        <h2 class="shout">Data holders in JavaScript,<br/>a few words about...</h2>
    </section>

    <section class="slide">
        <h2 class="shout">Map, Set, WeakMap, WeakSet</h2>
    </section>

    <section class="slide">
        <h2>Data Holders</h2>
        <ol>
            <li class="next"><code>Map</code></li>
            <li class="next"><code>Set</code></li>
            <li class="next"><code>WeakMap</code></li>
            <li class="next"><code>WeakSet</code></li>
            <li class="next"><code>Array</code> (well known)</li>
            <li class="next"><code>Object</code> (well known)</li>
        </ol>
    </section>

    <section class="slide">
        <h2 class="shout">Map</h2>
    </section>

    <section class="slide">
        <h2>Map</h2>
        <figure>
            <blockquote>
                <p>
                    The Map object is a simple key/value map.<br/>
                    Any value (both objects and primitive values) may be used as either a key or a value.
                </p>
            </blockquote>
            <figcaption>MDN @ 2016</figcaption>
        </figure>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #1: Real world
// ---------------------------------------------------------------------
var map = new Map()
map.set(['ie', 'moz'], 'a')
map.set(['ie', 'moz', 'firefox'], 'b')

function check(list, ...browsers) {
    for (let [key, value] of list)
        if (String(browsers) === String(key)) return value
}
check(map, 'ie', 'moz', 'firefox') // ???
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #2
// ---------------------------------------------------------------------
// Sprawdzenie wielkości kontenera.
// UWAGA: Właściwość `size` to tylko getter.
map.size // instead of: array.length

// Wyczyszczenie kontenera
map.clear() // instead of: array.length = 0

// Usunięcie pary klucz=wartość
map.delete(key) // instead of: array.splice(0, 1)
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #3
// ---------------------------------------------------------------------
// Pobranie wartości pojedynczego klucza
map.get(key) // instead of: object[key]

// Sprawdzenie, czy dany klucz jest użyty w kontenerze
map.has(key) // instead of: key in object albo array.indexOf(value) !== -1

// Dodanie do kontenera
map.set() // instead of: array.push(value)
// UWAGA: Niestety nie można w następujący sposób:
map.set(key1, val1, key2, val2) // podobnie jak tutaj: array.push(val1, val2, val3...)
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #4: MAGIA
// ---------------------------------------------------------------------
// Pobranie par: klucz, wartość z kontenera {MapIterator}
map.entries() // instead of: Object.entries(object) - ES2017 (a'ka ES8)

// Pobranie listy kluczy z kontenera {MapIterator}
map.keys() // instead of: Object.keys(object)

// Pobranie listy wartości z kontenera {MapIterator}
map.values() // instead of: Object.values(object) - ES2017 (a'ka ES8)

        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #5: Zwykła iteracja
// ---------------------------------------------------------------------

// Iteracja po kontenerze
map.forEach((value, key) => /* ... */) // to samo co w tablicy






        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #6: Casting
// ---------------------------------------------------------------------
// Rzutowanie na "string"
String(new Map) === "[object Map]"







        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #7
// ---------------------------------------------------------------------
var map = new Map();
map.set({}, 1) // Blokujemy sobie dostęp do wartości "1"
map.size // 1

// Spróbujmy jednak pobrać...
map.get({}) // undefined

// .. a może uda się usunąć?
map.delete({}) // false
map.size // 1

// Jak w takim razie pozbyć się takiego klucza i wartości?
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #8: Usuwanie wartości z kontenera
// ---------------------------------------------------------------------

// Wyczyszczenie całego kontenera pomaga...
map.clear()

// ...albo usunięcie w pętli.
for (var [key, value] of map.entries()) {
    map.delete(key) // true
}

        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #9
// ---------------------------------------------------------------------
map.set({ foo: 1 }, 'a')
map.set({ foo: 2 }, 'b')

var iterator = map.values() // {MapIterator}
var interval = setInterval(() => {
    let item = iterator.next()
    if (item.done) {
        clearInterval(interval)
        return
    }
    console.log(item.value) // 'a' => [ONE SECOND] => 'b'
}, 1000)
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #10
// ---------------------------------------------------------------------
var map = new Map()
map.set({ a: 1 }, 'a')

var mo = new Map(map.entries())

// Porównanie dwóch map nie powiedzie się, podobnie jak tablice.
(map === mo) // false

// Ale miałem nadzieje :)
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #11: WTF?
// ---------------------------------------------------------------------
var map = new Map()
map.set() // Map { undefined => undefined }
map.size // 1

// W kontenerze typu Array
var array = []
array.push()
array.length // 0

        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #12: "Holy" couple = { key, value }
// ---------------------------------------------------------------------
var map = new Map()

map.set([1, 2, 3], Math.random())
map.set([1, 2, 3], Math.random())
map.set([1, 2, 3], Math.random())
map.set([1, 2, 3], Math.random())

map.size // 4

        </code></pre>
    </section>

    <section class="slide">
        <h2 class="shout">Therefore, why Map is cool?</h2>
    </section>

    <section class="slide">
        <h2 class="shout">Set</h2>
    </section>

    <section class="slide">
        <h2>Set</h2>
        <figure>
            <blockquote>
                <p>
                    The Set object lets you store unique values of any type, whether primitive values or object references.
                </p>
            </blockquote>
            <figcaption>MDN @ 2016</figcaption>
        </figure>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #1: Masowe dodawanie
// ---------------------------------------------------------------------
var set = new Set()
var array = [1, 2, 3, 1, 3, 4, 5, 6, 6, 6, 6]

array.forEach(set.add.bind(set))
console.log(set) // [1, 2, 3, 4, 5, 6]

// Bez `bind` dostajemy błąd:
//   TypeError: Method Set.prototype.add called
//   on incompatible receiver undefined

        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #2: Usunięcie duplikatów
// ---------------------------------------------------------------------
var array = [1, 2, 3, 1, 3]

// Konstruktor przyjmuje inną kolekcję
[...new Set(array)] // [1, 2, 3]

// -----------------------------------

var map = new Map()
map.set({ foo: 1 }, 'a')
map.set({ foo: 2 }, 'b')

[...new Set(map.keys())] // [{ foo: 1 }, { foo: 2 }]
[...new Set(map.values())] // ['a', 'b']
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #3: Ojoj
// ---------------------------------------------------------------------

new Set(1, 2, 3, 4)
// TypeError: (var)[Symbol.iterator] is not a function






        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #4
// ---------------------------------------------------------------------
// Usuwanie z kontenera.
// UWAGA: Usuwanie odbywa się poprzez wartość, a nie indeks.
var set = new Set([1, 2, 3, 4])
set.delete(3) // true

console.log(set) // Set {1, 2, 4}

// albo po prostu...
set.clear() // ...i mamy pustego Set-a
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #5: MAGIA
// ---------------------------------------------------------------------
// Pobranie wartości z kontenera {SetIterator}
set.entries() // instead of: Object.entries(object) - ES2017 (a'ka ES8)

// Pobranie listy wartości z kontenera {SetIterator}
set.keys() // instead of: Object.keys(object)

// Pobranie listy wartości z kontenera {SetIterator}
set.values() // instead of: Object.values(object) - ES2017 (a'ka ES8)

// hmmm...
// set.values() oraz set.keys() zwracają Iterator,
// który będzie pracować na tych samych danych, jednak

set.values() === set.keys() // false

        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #6
// ---------------------------------------------------------------------
// Pobranie... a czego właściwie?
set.get(key) // TypeError: set.get is not a function

// Sprawdzenie, czy dana wartość znajduje się w kontenerze
set.has(value)

// instead of:
array.indexOf(value) !== -1
array.includes(value)
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #7
// ---------------------------------------------------------------------
// Dodanie do kontenera
set.add() // instead of: array.push(value)

// UWAGA: Niestety nie można w następujący sposób:
set.add(val1, val2, val3...)

// podobnie jak tutaj:
array.push(val1, val2, val3...)

        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #8: Prosta iteracja
// ---------------------------------------------------------------------
var set = new Set([1, 1, 2])

set.forEach((i) => {
    console.log(i) // 1, 2
})




        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #10: Casting
// ---------------------------------------------------------------------

// Rzutowanie na "string"
String(new Set) === "[object Set]"






        </code></pre>
    </section>

    <section class="slide">
        <h2 class="shout">Therefore, why Set is cool?</h2>
    </section>

    <section class="slide">
        <h2 class="shout">WeakMap</h2>
    </section>

    <section class="slide">
        <h2>WeakMap</h2>
        <figure>
            <blockquote>
                <p>
                    The WeakMap object is a collection of key/value pairs in which the keys are weakly referenced.<br/>
                    The keys must be objects and the values can be arbitrary values.
                </p>
            </blockquote>
            <figcaption>MDN @ 2016</figcaption>
        </figure>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #1: Ubogość
// ---------------------------------------------------------------------
var weakMap = new WeakMap()
var key = { foo: 1 }

weakMap.set(1, 4) // TypeError: Invalid value used as weak map key
weakMap.set([1], 5) // WeakMap { [1] => 5 }
weakMap.set(key, 6) // WeakMap { [1] => 5, {foo: 1} => 6 }

weakMap.get([1, 2, 3]) // undefined
weakMap.get(key) // 6

weakMap.has([1]) // false
weakMap.has(key) // true

weakMap.delete([1]) // false
weakMap.delete(key) // true

// nie ma więcej metod...
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #2: Casting
// ---------------------------------------------------------------------

// Rzutowanie na "string"
String(new WeakMap) === "[object WeakMap]"






        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #3: Errors
// ---------------------------------------------------------------------
new WeakMap(1)
// TypeError: (var)[Symbol.iterator] is not a function

new WeakMap([1])
new WeakMap(new Set([1]))
// TypeError: Iterator value 1 is not an entry object

new WeakMap(new Set([1]).entries())
// TypeError: Invalid value used as weak map key
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #4: "Holy" couple = { key, value }
// ---------------------------------------------------------------------
var weakMap = new WeakMap()

weakMap.set([1, 2, 3], Math.random())
weakMap.set([1, 2, 3], Math.random()) // ojoj...
weakMap.set([1, 2, 3], Math.random()) // ojoj...




        </code></pre>
    </section>

    <section class="slide">
        <h2 class="shout">Therefore, why WeakMap is cool?</h2>
    </section>

    <section class="slide">
        <h2 class="shout">WeakSet</h2>
    </section>

    <section class="slide">
        <h2>WeakSet</h2>
        <figure>
            <blockquote>
                <p>
                    The WeakSet object lets you store weakly held objects in a collection.
                </p>
            </blockquote>
            <figcaption>MDN @ 2016</figcaption>
        </figure>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #1: Problem z konstruktorem
// ---------------------------------------------------------------------

new WeakSet([1, 2, 3]);
// TypeError: Invalid value used in weak set

new WeakSet(1, 2, 3);
// TypeError: (var)[Symbol.iterator] is not a function




        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #2: Proste API
// ---------------------------------------------------------------------
// Dodajemy tylko obiekty (Array, Function, RegExp, Object)
weakSet.add(1) // TypeError: Invalid value used in weak set
weakSet.add([1]) // WeakSet {[1]}

// Sprawdzanie przez referencję.
weakSet.has([1]) // false

// Usuwanie również przez referencję.
weakSet.delete([1]) // false
console.log(weakSet) // WeakSet {[1]}
        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #3: Rzutowanie
// ---------------------------------------------------------------------

// Rzutowanie na "string"
String(new WeakSet) === '[object WeakSet]'







        </code></pre>
    </section>

    <section class="slide">
        <pre class="cover"><code class="language-javascript">
// Example #4: Remove duplicated objects
// ---------------------------------------------------------------------
var o = { foo: 1 }
var advanced = [ o, { foo: 2 }, { foo: 3 }, o ];

[...new Set(advanced)] // Array[3]
[...new WeakSet(advanced)]
// TypeError: (intermediate value)[Symbol.iterator] is not a function

var weakSet = new WeakSet();
advanced.forEach(weakSet.add.bind(weakSet))
// WeakSet {Object {foo: 1}, Object {foo: 2}, Object {foo: 3}}
// ...ale to już Set zapewnia
        </code></pre>
    </section>

    <section class="slide">
        <h2 class="shout">Therefore, why WeakSet is cool?</h2>
    </section>

    <section class="slide">
        <h2>TODO</h2>
        <ul>
            <li>weryfikacja pamięci (ile zajmują dane) przy takich samych danych w różnych kontenerach</li>
            <li>przebadać WeakMap oraz WeakSet pod kątem Memory Leak (prawdopodobnie klucze są usuwane przez GC)</li>
            <li>dodać przykłady wykorzystania WeakSet i WeakMap</li>
        </ul>

        <p class="note">This is last slide. Thanks!</p>
    </section>

    <p class="badge">
        <a href="https://github.com/piecioshka/slides-map-set-weakmap-weakset">Fork me on GitHub</a>
    </p>
    <div class="progress"></div>

    <script src="https://npmcdn.com/shower-core/shower.min.js"></script>
    <script src="vendors/prism.js"></script>
</body>
</html>
